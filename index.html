<!doctype html>
<html lang="en"> 
 <head> 
  <meta charset="utf-8"> 
  <meta name="viewport" content="width=device-width,initial-scale=1"> 
  <title>Steddy Trading Co. Ltd - Properties Admin</title> 
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> 
  <style>
    :root {
      --green: #006400;
      --black: #000000;
      --muted: #f2f2f2;
      --card: #ffffff;
    }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(180deg, #fbfbfb 0%, #f6f6f6 100%);
      color:#222;
    }
    header{
      background: linear-gradient(90deg,var(--green), var(--black));
      color:#fff;
      padding:16px 20px;
    }
    header h1{ margin:0; font-size:20px; }
    .brand-sub { opacity:0.9; font-size:13px; margin-top:6px; }
    nav{
      display:flex;
      background: #fff;
      border-bottom: 1px solid #e7e7e7;
    }
    nav button{
      flex:1;
      padding:12px 14px;
      border:0;
      background:transparent;
      cursor:pointer;
      font-weight:600;
    }
    nav button.active, nav button:hover { background:#f3f3f3; }
    .container{ padding:20px; max-width:1100px; margin:0 auto; }
    .section{ display:none; }
    .section.active{ display:block; }
    table{ width:100%; border-collapse:collapse; background:var(--card); box-shadow:0 1px 2px rgba(0,0,0,0.03); }
    th,td{ padding:10px 12px; border-bottom:1px solid #eee; text-align:left; vertical-align:middle; }
    th{ background:#fafafa; font-weight:700; }
    .property-img{ width:120px; height:auto; max-height:80px; object-fit:cover; border-radius:6px; border:1px solid #e6e6e6; }
    form input[type="text"], form input[type="number"], form textarea, form select {
      width:100%; max-width:520px; padding:10px; margin-top:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;
    }
    form label{ display:block; margin-top:12px; font-weight:600; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:8px; }
    .small { width:160px; }
    .action-btn {
      display:inline-block;
      padding:8px 10px;
      background:var(--green);
      color:#fff;
      border:0;
      border-radius:6px;
      cursor:pointer;
      margin-right:6px;
    }
    .danger { background:#d33; }
    .muted { color:#666; font-size:13px; }
    .note { margin-top:8px; font-size:13px; color:#555; }
  </style> 
 </head> 
 <body> 
  <header> 
   <div> 
    <h1>Steddy Trading Co. Ltd — Admin Panel</h1> 
    <div class="brand-sub">
     Manage Properties • Green &amp; Black Theme
    </div> 
   </div> 
  </header> 
  <nav> <button class="tab active" data-tab="properties">Properties</button> <button class="tab" data-tab="upload">Upload / Edit Property</button> 
  </nav> 
  <div class="container"> 
   <section id="properties" class="section active"> 
    <h2>Properties</h2> 
    <table id="propertiesTable" aria-live="polite"> 
     <thead> 
      <tr> 
       <th>Image</th> 
       <th>Title</th> 
       <th>Price</th> 
       <th>Location</th> 
       <th>Description</th> 
       <th>Actions</th> 
      </tr> 
     </thead> 
     <tbody></tbody> 
    </table> 
    <p class="note">Tip: Click "Upload / Edit Property" to add or change records. Existing images are preserved unless you upload new ones.</p> 
   </section> 
   <section id="upload" class="section"> 
    <h2 id="formTitle">Upload New Property</h2> 
    <form id="uploadForm"> 
     <input type="hidden" id="propertyId"> <label for="title">Title</label> 
     <input id="title" type="text" placeholder="3 Bedroom Apartment in Kilimani" required> 
     <div class="row"> 
      <div> <label for="price">Price (number)</label> 
       <input id="price" type="number" step="0.01" placeholder="85000" required> 
      </div> 
      <div> <label for="location">Location</label> 
       <input id="location" type="text" placeholder="Kilimani, Nairobi" required> 
      </div> 
     </div> <label for="description">Description</label> <textarea id="description" rows="4" placeholder="Spacious apartment with modern finishes..." required></textarea> <label for="images">Images (multiple allowed)</label> 
     <input id="images" type="file" accept="image/*" multiple> 
     <div style="margin-top:12px;"> <button class="action-btn" type="submit">Save Property</button> <button type="button" id="resetBtn" style="margin-left:8px;">Reset</button> 
     </div> 
     <p class="muted">If you leave the image input empty while updating, existing images will be kept.</p> 
    </form> 
   </section> 
  </div> 
  <script>
    // === Backendless credentials (YOUR corrected values) ===
    const APP_ID = "0A7AD52F-FCFA-4EA6-B8BE-3866F42ECD0A";
    const REST_API_KEY = "513E911B-04C0-4789-B660-627949989BE9";
    const BASE = `https://api.backendless.com/${APP_ID}/${REST_API_KEY}`;
    const DATA_ENDPOINT = `${BASE}/data/Properties`;
    const axiosJsonConfig = { headers: { "Content-Type": "application/json" } };

    // UI references
    const tabs = document.querySelectorAll(".tab");
    const sections = document.querySelectorAll(".section");
    const propertiesTbody = document.querySelector("#propertiesTable tbody");
    const uploadForm = document.getElementById("uploadForm");
    const resetBtn = document.getElementById("resetBtn");
    const formTitle = document.getElementById("formTitle");

    // Form fields
    const fldId = document.getElementById("propertyId");
    const fldTitle = document.getElementById("title");
    const fldPrice = document.getElementById("price");
    const fldLocation = document.getElementById("location");
    const fldDescription = document.getElementById("description");
    const fldImages = document.getElementById("images");

    let currentImageUrls = []; // holds existing imageurls when editing

    // Tab switching
    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        tabs.forEach(b => b.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
      });
    });

    // Utility: human currency formatting (KES)
    function formatKES(value) {
      if (value === undefined || value === null || isNaN(Number(value))) return "-";
      try {
        return "KES " + new Intl.NumberFormat().format(Number(value));
      } catch {
        return "KES " + value;
      }
    }

    // Fetch and render properties
    async function fetchProperties() {
      try {
        const res = await axios.get(DATA_ENDPOINT, axiosJsonConfig);
        const items = Array.isArray(res.data) ? res.data : [];
        propertiesTbody.innerHTML = "";
        items.forEach(p => {
          const mainImage = Array.isArray(p.imageurls) && p.imageurls.length ? p.imageurls[0] : "";
          const descShort = (p.description || "").length > 120 ? (p.description || "").slice(0, 117) + "..." : (p.description || "");
          propertiesTbody.innerHTML += `
            <tr>
              <td>${ mainImage ? `<img src="${mainImage}" class="property-img" alt="property image">` : `<div style="width:120px;height:80px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;border-radius:6px;color:#999">No image</div>` }</td>
              <td>${escapeHtml(p.title || "-")}</td>
              <td>${formatKES(p.price)}</td>
              <td>${escapeHtml(p.location || "-")}</td>
              <td style="max-width:340px">${escapeHtml(descShort)}</td>
              <td>
                <button class="action-btn" onclick="loadForUpdate('${p.objectId}')">Edit</button>
                <button class="action-btn danger" onclick="deleteProperty('${p.objectId}')">Delete</button>
              </td>
            </tr>
          `;
        });
      } catch (err) {
        console.error("Error fetching properties:", err?.response?.data || err.message || err);
        alert("Failed to fetch properties. Check console for details.");
      }
    }

    // Delete property
    async function deleteProperty(id){
      try {
        if (!confirm("Delete this property?")) return;
        await axios.delete(`${DATA_ENDPOINT}/${id}`, axiosJsonConfig);
        alert("Property deleted.");
        fetchProperties();
      } catch (err) {
        console.error("Delete error:", err?.response?.data || err.message || err);
        alert("Failed to delete property.");
      }
    }

    // Load property to form for update
    async function loadForUpdate(id){
      try {
        const res = await axios.get(`${DATA_ENDPOINT}/${id}`, axiosJsonConfig);
        const p = res.data;
        fldId.value = id;
        fldTitle.value = p.title || "";
        fldPrice.value = p.price ?? "";
        fldLocation.value = p.location || "";
        fldDescription.value = p.description || "";

        currentImageUrls = Array.isArray(p.imageurls) ? p.imageurls.slice() : [];

        formTitle.textContent = "Edit Property";
        // switch to upload tab
        document.querySelector('[data-tab="upload"]').click();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (err) {
        console.error("Load for update error:", err?.response?.data || err.message || err);
        alert("Failed to load property for editing.");
      }
    }

    // Reset form
    function resetForm(){
      fldId.value = "";
      fldTitle.value = "";
      fldPrice.value = "";
      fldLocation.value = "";
      fldDescription.value = "";
      fldImages.value = "";
      currentImageUrls = [];
      formTitle.textContent = "Upload New Property";
    }

    resetBtn.addEventListener("click", (e) => {
      e.preventDefault();
      resetForm();
    });

    // Submit (create/update)
    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = fldId.value;
      const title = fldTitle.value.trim();
      const price = fldPrice.value !== "" ? parseFloat(fldPrice.value) : null;
      const location = fldLocation.value.trim();
      const description = fldDescription.value.trim();
      const files = fldImages.files;

      if (!title || price === null || !location || !description) {
        return alert("Please fill Title, Price, Location and Description.");
      }

      try {
        // Upload files (if any) to Backendless File storage
        let uploadedUrls = [];
        if (files && files.length) {
          // upload each file and collect the file URLs
          const uploadPromises = Array.from(files).map(async (file) => {
            // prepend timestamp to avoid accidental collisions
            const safeFileName = `${Date.now()}-${sanitizeFileName(file.name)}`;
            const uploadUrl = `${BASE}/files/properties-images/${encodeURIComponent(safeFileName)}?overwrite=true`;
            const form = new FormData();
            form.append('file', file);
            // IMPORTANT: Do not send application/json header for file uploads
            const resp = await axios.post(uploadUrl, form, { headers: { 'Content-Type': 'multipart/form-data' } });
            // Backendless file URL format:
            return `https://backendlessappcontent.com/${APP_ID}/${REST_API_KEY}/files/properties-images/${encodeURIComponent(safeFileName)}`;
          });
          uploadedUrls = await Promise.all(uploadPromises);
        }

        // final imageurls value: either newly uploaded URLs (if any) or existing currentImageUrls (when editing)
        const finalImageUrls = uploadedUrls.length ? uploadedUrls : (currentImageUrls.length ? currentImageUrls : []);

        // assemble payload
        const payload = {
          title,
          description,
          price,
          location,
          imageurls: finalImageUrls,
        };

        // remove undefined fields so Backendless doesn't reject them
        Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);

        if (id) {
          // Update existing property
          await axios.put(`${DATA_ENDPOINT}/${id}`, payload, axiosJsonConfig);
          alert("Property updated.");
        } else {
          // Create
          await axios.post(DATA_ENDPOINT, payload, axiosJsonConfig);
          alert("Property created.");
        }

        resetForm();
        fetchProperties();
        // switch to properties tab
        document.querySelector('[data-tab="properties"]').click();
      } catch (err) {
        console.error("Upload/Update error:", err?.response?.data || err.message || err);
        // Provide a helpful error message if available
        const msg = err?.response?.data?.message || err?.response?.data || err.message || 'Unknown error';
        alert("Failed to save property: " + JSON.stringify(msg));
      }
    });

    // Small helpers
    function sanitizeFileName(name) {
      return name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_.]/g, '');
    }
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // Expose these functions to window so inline onclick can call them
    window.loadForUpdate = loadForUpdate;
    window.deleteProperty = deleteProperty;

    // initial load
    fetchProperties();
  </script> 
 </body>
</html>/
